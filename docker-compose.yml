version: "3"

services:
  dtapac:
    build: .
    depends_on:
    - dtrack
    - opa
    environment:
      DTAPAC_DTRACK_URL: "http://dtrack:8080"
      DTAPAC_DTRACK_APIKEY: "${DTAPAC_DTRACK_APIKEY}"
      DTAPAC_OPA_URL: "http://opa:8181"
      DTAPAC_OPA_BUNDLE: "dtapac"
      DTAPAC_LOG_LEVEL: "debug"
    networks:
    - public
    ports:
    - "127.0.0.1:8081:8080"
    restart: unless-stopped

  dtrack:
    image: dependencytrack/bundled:4.4.2@sha256:c46d6ae8575236507c81c85a32035c5067c336ffe32c100da09d878431cf2b96
    networks:
    - public
    ports:
    - "127.0.0.1:8080:8080"
    restart: unless-stopped

  opa:
    image: openpolicyagent/opa:0.39.0-rootless@sha256:8b799624170a413497abeb0bd49ae9b330fd317f0ad3ef9587332d5a5b760047
    command:
    - run
    - --server
    # (Periodically) pull mybundle from NGINX
    - --set=services.bundle_server.url=http://opa_bundle_server
    - --set=bundles.dtapac.service=bundle_server
    - --set=bundles.dtapac.resource=bundles/dtapac.tar.gz
    # Send status notifications to DTAPAC
    - --set=services.dtapac.url=http://dtapac:8080/opa
    - --set=status.service=dtapac
    depends_on:
    - opa_bundle_server
    networks:
    - opa_internal
    - public
    ports:
    - "127.0.0.1:8181:8181"
    restart: unless-stopped

  opa_bundle_server:
    image: nginx:1.21.6-alpine@sha256:5a0df7fb7c8c03e4158ae9974bfbd6a15da2bdfdeded4fb694367ec812325d31
    networks:
    - opa_internal
    volumes:
    - "./examples/bundles:/usr/share/nginx/html/bundles:ro"
    restart: unless-stopped

networks:
  public: {}
  opa_internal:
    internal: true